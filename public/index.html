
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>BlockCraft</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta property="og:title" content="BlockCraft" />
		<meta property="og:type" content="website" />
		<meta property="og:url" content="https://blockcraft.victorwei.com" />
		<meta property="og:image" content="https://blockcraft.victorwei.com/content.png" />
		<meta property="og:description" content="BlockCraft is a WebGL implementation of an infinite procedurally-generated voxel world that runs on the browser. This project originally spawned as a Minecraft Classic clone but has expanded to include multiplayer PvP, crafting, shaders and much more!" />
		<meta name="keywords" content="HTML, CSS, JavaScript, Three.js">
		<meta name="author" content="Victor Wei">

		<link rel="stylesheet" href="style.css">
		<link rel="shortcut icon" type="image/png" href="./favicon.png"/>
	</head>
	<body>
		
		<canvas id="canvas-hud"></canvas>

		<script src="https://cdn.jsdelivr.net/npm/ola"></script>

		<!-- Load Resources -->
		<script src="javascripts/resources/three.min.js"></script>
		<script src="javascripts/resources/SVGLoader.js"></script>
		<script src="javascripts/resources/socket.io.js"></script>
		<script src="javascripts/resources/stats.min.js"></script>
		<script src="javascripts/resources/perlin.js"></script>
		<script src="javascripts/resources/simplex.js"></script>
		<script src="javascripts/resources/matrix.js"></script>
		<script src="javascripts/resources/sizeof.js"></script>
		<script src="javascripts/resources/jquery.js"></script>
		<script src="javascripts/resources/cookie.js"></script>
		<script src="javascripts/resources/rle-encoding.js"></script>
		<script src="javascripts/resources/GLTFLoader.js"></script>
		<script src="javascripts/resources/Inflate.min.js"></script>
		<script src="javascripts/resources/TextureMerger.js"></script>

		<!-- Load Postprocessing -->
		<script src="javascripts/postprocessing/EffectComposer.js"></script>
		<script src="javascripts/postprocessing/RenderPass.js"></script>
		<script src="javascripts/postprocessing/ShaderPass.js"></script>
		<script src="javascripts/postprocessing/CopyShader.js"></script>

		<!-- Load Classes -->
		<script src="javascripts/classes/World.js"></script>
		<script src="javascripts/classes/Stage.js"></script>
		<script src="javascripts/classes/ChunkManager.js"></script>
		<script src="javascripts/classes/Player.js"></script>
		<script src="javascripts/classes/Stats.js"></script>
		<script src="javascripts/classes/Recipes.js"></script>

		<!-- Load Game Files -->
		<script src="javascripts/auth.js"></script>
		<script src="javascripts/pointerlock.js"></script>
		<script src="javascripts/server.js"></script>
		<script src="javascripts/core.js"></script>
		<script src="javascripts/textures.js"></script>
		<script src="javascripts/client.js"></script>
		<script src="javascripts/input.js"></script>
		<script src="javascripts/helper.js"></script>
		<script src="javascripts/hud.js"></script>
		

		<div id="blocker">
			<div id="background-image"></div>

			<div id="container">
				<h1 id="title">BlockCraft</h1>
				<div id="nav">
					<button class="tablinks" onclick="changeTab(event, 'welcome')" id="welcome-button">Welcome</button>
					<button class="tablinks" onclick="changeTab(event, 'server-list')">Servers</button>
					<button class="tablinks" onclick="changeTab(event, 'changelog')">Changelog</button>
					<button class="tablinks" onclick="changeTab(event, 'video-settings')">Video</button>
					<button class="tablinks" onclick="changeTab(event, 'keyboard-settings')">Keyboard</button>
				</div>

				<div id="welcome" class="tabcontent">
					<span>BlockCraft is a WebGL implementation of a procedurally-generated voxel world that runs on the web browser. This project started off as a Minecraft Classic clone but has  This project originally spawned as a Minecraft Classic clone but has expanded to include multiplayer PvP, crafting, shaders and much more!</span><br><br>
					<span>BlockCraft is not affiliated with (or supported by) Mojang AB, Minecraft, or Microsoft in any way.</span><br><br>
					<span>You can view my development journey <a href="https://victorwei.com/blog/blockcraft.pdf">here</a></span><br><br>
					<span>This project is open source and the source code can be accessed through <a href="https://github.com/victoryqwei/blockcraft/" style="color: white" target="_blank">Github</a></span><br><br>
					<span>You can view my other projects <a href="https://victorwei.com" target="_blank">here</a></span><br><br>
				</div>

				<div id="server-list" class="tabcontent">
					<div id="refresh-servers">Refresh</div>
					
					<div id="server-container"></div>
				</div>

				<div id="changelog" class="tabcontent" style="display: none;"></div>

				<div id="video-settings" class="tabcontent" style="display: none;">
					<span id="sensitivityValue" class="slider-text">Sensitivity: 50</span>
					<input type="range" min="1" max="100" value="50" class="slider" id="sensitivitySlider" style="position: relative; float: right; width: 50%; height: 20px"><br /><br />
					<span id="renderDistanceValue" class="slider-text">Render Distance: 8</span>
					<input type="range" min="1" max="12" value="8" class="slider" id="renderDistanceSlider" style="position: relative; float: right; width: 50%; height: 20px"><br /><br />
					<span id="chunkLoadingRateValue" class="slider-text">Chunk Loading Rate: 1</span>
					<input type="range" min="0" max="10" value="1" class="slider" id="chunkLoadingRateSlider" style="position: relative; float: right; width: 50%; height: 20px"><br /><br />
					<span id="statsValue" class="slider-text">Statistics: ON</span>
					<input type="range" min="0" max="1" value="1" class="slider" id="statsSlider" style="position: relative; float: right; width: 40px; height: 20px"><br /><br />
					<span id="shadowValue" class="slider-text">Shadow Effect: OFF</span>
					<input type="range" min="0" max="1" value="0" class="slider" id="shadowSlider" style="position: relative; float: right; width: 40px; height: 20px"><br /><br />
					<span id="cloudValue" class="slider-text">Clouds: ON</span>
					<input type="range" min="0" max="1" value="1" class="slider" id="cloudSlider" style="position: relative; float: right; width: 40px; height: 20px"><br /><br />
					<span id="starsValue" class="slider-text">Stars: ON</span>
					<input type="range" min="0" max="1" value="1" class="slider" id="starsSlider" style="position: relative; float: right; width: 40px; height: 20px">
					<div id="reset-video">Reset to Default</div>
				</div>

				<div id="keyboard-settings" class="tabcontent" style="display: none;">
				</div>

				<div id ="name-container">
					<input autocomplete="off" id="name-input" type="text" placeholder="Enter Username" maxlength="20">
					<br />
					<div id="start-button">
						<div id="loading-bar">
							Loading 0%
						</div>
					</div>
				</div>
			</div>
		</div>

		<input autocomplete="off" id="chat-input" type="text" placeholder="> Press Enter to Chat" maxlength="100">


		<script>

			// Change tab
			function changeTab(evt, cityName) {
			  // Declare all variables
			  var i, tabcontent, tablinks;

			  // Get all elements with class="tabcontent" and hide them
			  tabcontent = document.getElementsByClassName("tabcontent");
			  for (i = 0; i < tabcontent.length; i++) {
			    tabcontent[i].style.display = "none";
			  }

			  // Get all elements with class="tablinks" and remove the class "active"
			  tablinks = document.getElementsByClassName("tablinks");
			  for (i = 0; i < tablinks.length; i++) {
			    tablinks[i].className = tablinks[i].className.replace(" active", "");
			  }

			  // Show the current tab, and add an "active" class to the button that opened the tab
			  document.getElementById(cityName).style.display = "block";
			  evt.currentTarget.className += " active";
			}

			// Add version controls

			let changelog = [
				{
					"date": "Dec 17, 2021",
					"version": "0.25.0",
					"changes": "Players now spawn on the ground if possible| Added CORS support| Fixed crosshair jerk due to a Chrome bug| Fixed z-fighting issue with transparent blocks/items| Fixed players join with a default name| Optimized chunk loading by reducing the latency of web workers"
				},
				{
					"date": "Nov 8, 2020",
					"version": "0.24.0",
					"changes": "Added creative mode| Added commands such as /tp and /gamemode"
				},
				{
					"date": "Nov 7, 2020",
					"version": "0.23.0",
					"changes": "Added multiple new blocks| Improved terrain generation| Simplified texture loading process"
				},
				{
					"date": "Nov 6, 2020",
					"version": "0.22.0",
					"changes": "Added a versions tab to the start menu to see previous versions| Added multiplayer hand models| Added blocking functionality to the sword to reduce incoming damage and knockback| Added bunny hopping| Fixed blocks being able to be placed on water| Added cobblestone, sand, gravel, and obsidian blocks"
				},
				{
					"date": "Nov 5, 2020",
					"version": "0.21.0",
					"changes": "Fixed players being able to punch through walls| Improved start menu UI| Added start menu loading bar| World save messages no longer clog up the chat| Added the ability to reassign controls| Added cookies so video and keyboard settings can be saved"
				},
				{
					"date": "Nov 3, 2020",
					"version": "0.20.0",
					"changes": "Added stars| Improved night time lighting| Optimized texture atlas generation| Player arm now switches to the selected block| Added a sword| Added a tab so players are able to see who is online"
				},
				{
					"date": "Oct 29, 2020",
					"version": "0.19.0",
					"changes": "Improved swimming mechanics| Items now snap to player instead of gravitate| Worlds are able to be saved now"
				},
				{
					"date": "Oct 28, 2020",
					"version": "0.18.0",
					"changes": "Breaking blocks and placing blocks on chunk boundaries only update those chunks which are affected| Added the moon| Smoothed out day-night transition| Fixed diagonal collision resolution| Fixed crouch building"
				},
				{
					"date": "Oct 27, 2020",
					"version": "0.17.0",
					"changes": "Players can take fall damage| Optimized chunk loading using web workers"
				},
			]
				

			for (let change of changelog) {
				let date = change.date;
				let version = change.version;
				let changes = change.changes.split("|");

				let message = $("<span>v" + version + " | " + date + "</span><br><br>");
				$("#changelog").append(message);

				for (let comment of changes) {
					
					let message = $("<span>- " + comment + "</span><br>");
					$("#changelog").append(message);
				}

		        $("#changelog").append($("<br>"));
			}

			// Add keys

			let keyorder = [188, 190, 87, 65, 83, 68, 32, 16, 18, 70, 67, 81, 82, 88, 69, 9, 49, 50, 51, 52, 53, 54, 55, 56, 57];
			let keymap = {
				188: ["Attack", ","],
				190: ["Place Block", "."],
				87: ["Move Forward", "W"],
				65: ["Move Left", "A"],
				83: ["Move Backward", "S"],
				68: ["Move Right", "D"],
				32: ["Jump", "SPACE"],
				16: ["Sprint", "SHIFT"],
				18: ["Sneak", "ALT"],
				70: ["Fly", "F"],
				67: ["Clip", "C"],
				81: ["Drop Item", "Q"],
				82: ["Respawn", "R"],
				88: ["Zoom", "X"],
				69: ["Open Inventory", "E"],
				9: ["Player Tab", "TAB"],
				49: ["Slot 1", "1"],
				50: ["Slot 2", "2"],
				51: ["Slot 3", "3"],
				52: ["Slot 4", "4"],
				53: ["Slot 5", "5"],
				54: ["Slot 6", "6"],
				55: ["Slot 7", "7"],
				56: ["Slot 8", "8"],
				57: ["Slot 9", "9"],
			}
			let savedKeymap = JSON.stringify(keymap);
			let savedKeyorder = JSON.stringify(keyorder);

			function addKeyControls() {
				$("#keyboard-settings").empty();

				keymap = JSON.parse(savedKeymap);

				// Adjust to cookies
				let adjust = [];
				for (let i = 0; i < keyorder.length; i++) {
					let key = keyorder[i];
					let cookie = getCookie(keymap[key][0]);
					if (cookie) {
						cookie = cookie.split(",");

						delete keymap[key];

						adjust.push(cookie);

						keyorder[i] = cookie[0]
					}
				}

				for (let cookie of adjust) {
					keymap[cookie[0]] = [cookie[1], cookie[2]]
				}

				// Add the key binds
				for (let key of keyorder) {
					let keyHTML = $('<div class="key"><span>' + keymap[key][0] + '</span><input class="change-key" placeholder="' + keymap[key][1] + '" data-keycode="' + key + '" readonly></div><br>')
					$("#keyboard-settings").append(keyHTML)
					keymap[key][2] = keymap[key][2] != undefined ? keymap[key][2] : true; // Enable
					keymap[key][3] = keyHTML[0]
					keymap[key][3].children[1].savedKey = key;
				}

				$("#keyboard-settings").append('<div id="reset-keyboard">Reset to Default</div>')

				$(".change-key").on('keydown', function (e) {
					if (e.keyCode == 32 || e.keyCode == 38 || e.keyCode == 40 || e.keyCode == 18)
						e.preventDefault();
				})

				$(".change-key").on('keyup', function (e) {
					let old_key = e.target.getAttribute("data-keycode");
					e.target.style.color = "white";
					let action = e.key;
					if (e.key == " ")
						action = "SPACE"

					if (e.keyCode == old_key) {
						keymap[old_key][2] = true;
						e.target.value = action.toUpperCase();
						return;
					}
					
					if (action == "Escape") {
						e.target.value = "NONE";
						keymap[old_key][2] = false;
						//console.log("Escape")

						setCookie(keymap[old_key][0], [old_key, keymap[old_key][0], keymap[old_key][1]], 7)
					} else if (keymap[e.keyCode] && keymap[old_key][2]) {
						e.target.value = action.toUpperCase();
						e.target.savedKey = e.keyCode;
						e.target.style.color = "red";
						//console.log("Error")
					} else {
						keymap[old_key][2] = true;
						e.target.setAttribute("data-keycode", e.keyCode);
						Object.defineProperty(keymap, e.keyCode,
					        Object.getOwnPropertyDescriptor(keymap, old_key));
					    delete keymap[old_key];
						e.target.value = action.toUpperCase();
						e.target.savedKey = e.keyCode;
						//console.log("Replace")

						for (let i = 0; i < keyorder.length; i++) {
							if (keyorder[i] == old_key)
								keyorder[i] = e.keyCode
						}

						setCookie(keymap[e.keyCode][0], [e.keyCode, keymap[e.keyCode][0], action.toUpperCase()], 7)
					}

					// Check if key has been cleared up
					for (let key in keymap) {
						let currKey = key;
						let shownKey = keymap[key][3].children[1].savedKey;
						if (shownKey && currKey != shownKey && keymap[shownKey]) {

							if (keymap[shownKey][3].children[1].style.color == "red" || keymap[shownKey][3].children[1].value == "NONE") {
								
								let copy = Object.getOwnPropertyDescriptor(keymap, shownKey);
								Object.defineProperty(keymap, shownKey,
							        Object.getOwnPropertyDescriptor(keymap, currKey));
								Object.defineProperty(keymap, currKey,
							        copy);
								keymap[currKey][3].children[1].style.color = "white";
								keymap[shownKey][3].children[1].style.color = "white";

								keymap[currKey][3].children[1].savedKey = currKey;
								keymap[shownKey][3].children[1].savedKey = shownKey;

								keymap[currKey][3].children[1].setAttribute("data-keycode", currKey);
								keymap[shownKey][3].children[1].setAttribute("data-keycode", shownKey);

								setCookie(keymap[currKey][0], [currKey, keymap[currKey][0], keymap[shownKey][1]], 7)
								setCookie(keymap[shownKey][0], [shownKey, keymap[shownKey][0], keymap[currKey][1]], 7)

								//console.log(currKey, shownKey , "SWITCHABLE")
							}
						}
					}
				})

				$(".change-key").on('blur', function (e) {
					if (e.target.value) {
						e.target.placeholder = e.target.value;
						e.target.value = "";
					}
				})

				$("#reset-keyboard").click(function () {
					for (let key of keyorder) {
						deleteCookie(keymap[key][0])
					}

					keyorder = JSON.parse(savedKeyorder)

					addKeyControls();
				})
			}
			addKeyControls();

			function addSliderControl(name, id, defaultValue, object, key) {
				// Sensitivity
				if (getCookie(name)) {
					object[key] = parseFloat(getCookie(name));
				} else {
					object[key] = defaultValue;
				}
				$("#" + id + "Value").text(name + ": " + object[key]);
				$("#" + id + "Slider")[0].value = object[key]
				$("#" + id + "Slider").off();
				$("#" + id + "Slider").on("change mousemove", function (e) {
					object[key] = $("#" + id + "Slider")[0].value;
					$("#" + id + "Value").text(name + ": " + object[key]);
					setCookie(name, object[key], 7);
				})
			}

			function addVideoControls() {
				addSliderControl("Sensitivity", "sensitivity", 50, player, "sens")
				addSliderControl("Render Distance", "renderDistance", 8, chunkManager, "renderDistance")
				addSliderControl("Chunk Loading Rate", "chunkLoadingRate", 1, chunkManager, "chunkLoadingRate");

				addSwitchControl("Statistics", "stats", true, hud, "showStats")
				addSwitchControl("Shadow Effect", "shadow", false, stage.dir, "enableShadow", "castShadow")
				addSwitchControl("Clouds", "cloud", true, stage, "showClouds", "generate")
				addSwitchControl("Stars", "stars", true, stage.stars, "visible")
			}

			function addSwitchControl(name, id, defaultValue, object, key, key2) {
				if (getCookie(name)) {
					object[key] = getCookie(name) == "true" ? true : false;
					if (key2)
						object[key2] = object[key];
				} else {
					object[key] = defaultValue;
					if (key2)
						object[key2] = object[key];
				}
				$("#" + id + "Value").text(name + ": " + (object[key] ? "ON" : "OFF"));
				$("#" + id + "Slider")[0].value = object[key] ? 1 : 0;
				$("#" + id + "Slider").off();
				$("#" + id + "Slider").on("change", function (e) {
					object[key] = $("#" + id + "Slider")[0].value == "1" ? true : false;
					if (key2)
						object[key2] = object[key];
					$("#" + id + "Value").text(name + ": " + (object[key] ? "ON" : "OFF"));
					setCookie(name, object[key], 7);
				})
			}

			$("#reset-video").click(function () {
				let videoCookies = ["Sensitivity", "Render Distance", "Chunk Loading Rate", "Statistics", "Shadow Effect", "Clouds", "Stars"];
				for (let cookie of videoCookies) {
					deleteCookie(cookie)
				}

				addVideoControls();
			})

			// Get cookie username

			let name = getCookie("Name");
			if (name)
				$("#name-input").val(name);

		</script>
	</body>
</html>
